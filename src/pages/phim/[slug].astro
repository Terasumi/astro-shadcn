---
import { type MovieResponseDetail } from "../../types";
import MovieDetailPage from "../../components/MovieDetailPage.astro";
import Layout from "../../layouts/Layout.astro";
const { slug } = Astro.params;
import "@/styles/globals.css";
import { getSecret } from "astro:env/server";
import {
    CACHE_CONFIGS,
    getCacheHeaders,
    getAstroCacheHeaders,
} from "@/lib/cache";
import { getCachedValue, setCachedValue } from "@/lib/server-cache";
const PUBLIC_PHIM_MOI = getSecret("PUBLIC_PHIM_MOI");
const cacheKey = `movie-detail:${slug}`;
let data = getCachedValue<MovieResponseDetail>(cacheKey);

if (!data) {
    if (!PUBLIC_PHIM_MOI) {
        throw new Error("Thiếu cấu hình API cho phim chi tiết.");
    }

    const response = await fetch(`${PUBLIC_PHIM_MOI}/phim/${slug}`, {
        cache: "force-cache",
        headers: getCacheHeaders(CACHE_CONFIGS.MOVIE_DETAIL),
    });

    if (!response.ok) {
        throw new Error(`Không thể tải dữ liệu phim: ${response.status}`);
    }

    data = await response.json();
    setCachedValue(cacheKey, data, CACHE_CONFIGS.MOVIE_DETAIL.maxAge);
}

const astroHeaders = {
    ...getCacheHeaders(CACHE_CONFIGS.MOVIE_DETAIL),
    ...getAstroCacheHeaders(),
};

for (const [key, value] of Object.entries(astroHeaders)) {
    Astro.response.headers.set(key, value);
}
---

<Layout title="Chi tiet">
    <MovieDetailPage data={data} slug={slug} />
</Layout>
