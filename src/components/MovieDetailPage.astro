---
import {
    Star,
    Calendar,
    Clock,
    Eye,
    Film,
    Captions,
    Proportions,
    Play,
    Share2,
    ThumbsUp,
    ThumbsDown,
    Plus,
} from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Separator } from "@/components/ui/separator";
import EpisodeSelector from "./EpisodeSelector";
import VideoPlayer from "./VideoPlayer";
import { Image } from "astro:assets";

const { data, slug: routeSlug } = Astro.props;
const movie = data.movie;
const slug = routeSlug ?? movie.slug;
const episodes = data.episodes;
const viewFormatter = new Intl.NumberFormat("vi-VN");
---

<div class="container mx-auto py-10 space-y-10">
    <!-- Movie Details -->
    <section
        class="relative isolate overflow-hidden rounded-3xl bg-slate-950 text-slate-50 shadow-2xl"
    >
        <div class="absolute inset-0">
            <Image
                loading="eager"
                src={movie.thumb_url ?? movie.poster_url}
                alt={movie.name}
                width={1600}
                height={900}
                class="h-full w-full object-cover"
                transition:name={`poster-${slug}`}
            />
            <div
                class="absolute inset-0 bg-gradient-to-r from-slate-950/95 via-slate-950/85 to-slate-900/20"
                aria-hidden="true"
            >
            </div>
        </div>
        <div
            class="relative z-10 flex flex-col gap-10 px-6 py-12 md:flex-row md:items-center"
        >
            <div class="mx-auto w-full max-w-sm shrink-0 md:mx-0">
                <Card
                    className="overflow-hidden rounded-3xl border-slate-800/60 bg-slate-900/70 shadow-2xl shadow-slate-950/40"
                >
                    <CardContent className="p-0">
                        <Image
                            loading="eager"
                            src={movie.poster_url}
                            alt={movie.name}
                            width={480}
                            height={720}
                            transition:name={`image-${slug}`}
                            class="h-full w-full object-cover"
                        />
                    </CardContent>
                </Card>
            </div>

            <div class="space-y-6 md:w-2/3">
                <div class="space-y-3">
                    <div
                        class="flex items-center gap-3 text-xs font-semibold uppercase tracking-[0.35em] text-slate-300/90"
                    >
                        <span
                            >{
                                movie.episode_total > 1 ? "Series" : "Movie"
                            }</span
                        >
                        <Separator
                            orientation="vertical"
                            className="h-6 bg-slate-700/70"
                        />
                        <span>{movie.status}</span>
                    </div>
                    <h1
                        class="text-3xl font-semibold tracking-tight text-slate-50 sm:text-4xl md:text-5xl"
                    >
                        {movie.name}
                    </h1>
                    <p class="text-lg text-slate-300">
                        {movie.origin_name}
                    </p>
                    <div
                        class="flex flex-wrap items-center gap-3 text-sm text-slate-200/80"
                    >
                        <Badge
                            variant="secondary"
                            className="rounded-full bg-slate-900/70 px-3 py-1 font-medium text-slate-100"
                        >
                            <Calendar
                                className="mr-2 h-4 w-4 text-slate-200/80"
                            />{movie.year}
                        </Badge>
                        <Badge
                            variant="secondary"
                            className="rounded-full bg-amber-500/10 px-3 py-1 font-medium text-amber-200"
                        >
                            {
                                movie.episode_total > 1
                                    ? `${movie.episode_current}/${movie.episode_total} tập`
                                    : movie.time
                            }
                        </Badge>
                        <span class="flex items-center gap-2">
                            <Star className="h-4 w-4 text-yellow-300" />{
                                movie.tmdb.vote_average
                            } / 10
                        </span>
                        <span class="flex items-center gap-2">
                            <Eye className="h-4 w-4" />{
                                viewFormatter.format(Number(movie.view) || 0)
                            } lượt xem
                        </span>
                    </div>
                </div>

                <div class="flex flex-wrap gap-2">
                    {
                        movie.category.map((cat: { name: string }) => (
                            <Badge
                                variant="secondary"
                                className="rounded-full bg-slate-900/70 px-3 py-1 text-slate-100"
                            >
                                {cat.name}
                            </Badge>
                        ))
                    }
                    {
                        movie.country.map((country: { name: string }) => (
                            <Badge
                                variant="outline"
                                className="rounded-full border-slate-700/80 bg-slate-900/40 px-3 py-1 text-slate-200"
                            >
                                {country.name}
                            </Badge>
                        ))
                    }
                </div>

                <div class="flex flex-col gap-3 text-sm text-slate-200">
                    <span>
                        <strong class="text-slate-100">Đạo diễn:</strong>
                        {
                            movie.director.length
                                ? ` ${movie.director.join(", ")}`
                                : " Đang cập nhật"
                        }
                    </span>
                    <span>
                        <strong class="text-slate-100">Diễn viên:</strong>
                        {
                            movie.actor.length
                                ? ` ${movie.actor.join(", ")}`
                                : " Đang cập nhật"
                        }
                    </span>
                </div>

                <div class="flex flex-wrap items-center gap-4">
                    <Button
                        asChild
                        size="lg"
                        className="rounded-full bg-slate-50 px-6 text-slate-900 hover:bg-white"
                    >
                        <a
                            href="#episode-selection"
                            class="h-9 flex items-center gap-2 rounded-full bg-slate-50 px-6 text-slate-900 hover:bg-white"
                        >
                            <Play className="h-4 w-4" /> Xem ngay
                        </a>
                    </Button>
                    <div class="flex flex-wrap gap-3 text-slate-200/80">
                        <button
                            class="flex items-center gap-2 rounded-full border border-slate-700/80 px-4 py-2 text-sm backdrop-blur-sm transition hover:border-slate-500"
                        >
                            <Plus className="h-4 w-4" /> Thêm vào danh sách
                        </button>
                        <button
                            class="flex items-center gap-2 rounded-full border border-slate-700/80 px-4 py-2 text-sm backdrop-blur-sm transition hover:border-slate-500"
                        >
                            <ThumbsUp className="h-4 w-4" /> Thích
                        </button>
                        <button
                            class="flex items-center gap-2 rounded-full border border-slate-700/80 px-4 py-2 text-sm backdrop-blur-sm transition hover:border-slate-500"
                        >
                            <Share2 className="h-4 w-4" /> Chia sẻ
                        </button>
                    </div>
                </div>

                <p class="max-w-2xl text-base leading-relaxed text-slate-200">
                    {movie.content}
                </p>
            </div>
        </div>
    </section>

    <!-- Episode Selection -->
    <section class="space-y-6" id="episode-selection">
        <section class="space-y-6">
            <h2 class="text-xl font-semibold text-slate-50">Chọn tập</h2>
            <Separator className="bg-slate-800" />
            {
                episodes.length > 0 ? (
                    <EpisodeSelector client:load episodes={episodes} />
                ) : (
                    <p class="text-slate-400">
                        Hiện chưa có tập nào được cập nhật.
                    </p>
                )
            }
        </section>

        <section class="space-y-6">
            <h2 class="text-xl font-semibold text-slate-50">
                Xem Trailer / Tập
            </h2>
            <Separator className="bg-slate-800" />
            <VideoPlayer client:load />
        </section>
    </section>
</div>
